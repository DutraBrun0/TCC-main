<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Faturamento - Mev Glass OS</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<header>
 <h1><a href="{{ url_for('inicio_page') }}">prodmanager</a></h1>
  <nav>
    <a href="{{ url_for('produtos_page') }}">Produtos</a>
    <a href="{{ url_for('clientes_page') }}">Cadastrar Cliente</a>
    <a href="{{url_for('lista_cliente_page')}}">lista clientes</a>
    <a href="{{ url_for('estoque_page') }}">Estoque</a>
    <a href="{{ url_for('faturamento_page') }}">Faturamento</a>
  </nav>
</header>
<main>
  <section>
    <h2>Registrar Venda</h2>
    <form id="faturamento-form">
      <select id="fatura-cliente" required><option>Carregando clientes...</option></select>
      <select id="fatura-produto" required><option>Carregando produtos...</option></select>
      <input type="number" id="fatura-quantidade" placeholder="Quantidade" min="1" required>
      <button type="submit">Registrar Venda</button>
    </form>

    <h3>Faturamentos</h3>
    <table id="faturamento-table">
      <thead><tr><th>Pedido ID</th><th>Cliente</th><th>Produto (SKU)</th><th>Quantidade</th><th>Total</th><th>AÃ§Ã£o</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script>
async function carregarDados() {
    // Carrega clientes
    const clientes = await fetch("/api/clientes").then(r => r.json());
    const produtos = await fetch("/produto/catalogo").then(r => r.json());

    const clienteSelect = document.getElementById("fatura-cliente");
    const produtoSelect = document.getElementById("fatura-produto");

    clienteSelect.innerHTML = "<option value=''>Selecione Cliente</option>";
    produtoSelect.innerHTML = "<option value=''>Selecione Variante</option>";

    clientes.forEach(c => {
        clienteSelect.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
    });

    produtos.forEach(p => {
        produtoSelect.innerHTML += `
            <option value="${p.variante_id}" data-estoque="${p.estoque}" data-preco="${p.preco_base}">
                ${p.linha} ${p.formato} (${p.sku}) - Estoque: ${p.estoque}
            </option>
        `;
    });
}

document.getElementById("faturamento-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const cliente = document.getElementById("fatura-cliente").value;
    const produto = document.getElementById("fatura-produto");
    const variante_id = produto.value;
    const quantidade = parseInt(document.getElementById("fatura-quantidade").value);

    const estoqueDisponivel = parseInt(produto.selectedOptions[0].dataset.estoque);
    const precoUnit = parseFloat(produto.selectedOptions[0].dataset.preco.replace(",", "."));
    // ðŸš¨ BLOQUEIA VENDA MAIOR QUE O ESTOQUE
    if (quantidade > estoqueDisponivel) {
        alert(`âŒ Estoque insuficiente.\nDisponÃ­vel: ${estoqueDisponivel}\nSolicitado: ${quantidade}`);
        return;
    }

    const payload = {
        cliente_id: cliente,
        itens: [{
            variante_id: variante_id,
            quantidade: quantidade,
            preco_unit: precoUnit
        }]
    };

    const resposta = await fetch("/pedido/criar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    const data = await resposta.json();

    if (data.error) {
        alert("âŒ Erro: " + data.error);
        return;
    }

    alert(`âœ” Venda registrada!\nTotal: R$ ${data.total}`);

    carregarDados();
    carregarTabelaFaturamentos();
    e.target.reset();
});

document.getElementById("fatura-produto").addEventListener("change", () => {
    const produto = document.getElementById("fatura-produto");
    const estoque = produto.selectedOptions[0].dataset.estoque;
    const btn = document.querySelector("button[type='submit']");

    if (estoque <= 0) {
        btn.disabled = true;
        btn.innerText = "Sem estoque";
        btn.style.background = "#888";
    } else {
        btn.disabled = false;
        btn.innerText = "Registrar Venda";
        btn.style.background = "";
    }
});
carregarDados();
</script>
</body>
</html>
