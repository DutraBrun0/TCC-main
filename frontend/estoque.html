<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Estoque - Mev Glass OS</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<style>
  table { width:100%; border-collapse: collapse; margin-top:15px; }
  th, td { border:1px solid #ddd; padding:8px; text-align:left; }
  th { background:#f3f3f3; }
  .estoque-input { width:70px; }
  button { cursor:pointer; }
</style>
</head>

<body>
<header>
<h1><a href="{{ url_for('inicio_page') }}">prodmanager</a></h1>
  <nav>
    <a href="{{ url_for('produtos_page') }}">Produtos</a>
    <a href="{{ url_for('clientes_page') }}">Clientes</a>
    <a href="{{url_for('lista_cliente_page')}}">lista clientes</a>
    <a href="{{ url_for('estoque_page') }}">Estoque</a>
    <a href="{{ url_for('faturamento_page') }}">Faturamento</a>
  </nav>
</header>

<main>
<section>
  <h2>Controle de Estoque por SKU</h2>

  <table>
    <thead>
      <tr>
        <th>SKU</th>
        <th>Produto</th>
        <th>Dimensões</th>
        <th>Cor / Moldura</th>
        <th>Preço Base</th>
        <th>Quantidade</th>
        <th>Entrada</th>
        <th>Saída</th>
      </tr>
    </thead>
    <tbody id="tabela-estoque"></tbody>
  </table>
</section>
</main>

<script>
async function carregarEstoque() {
  const req = await fetch("/estoque/variantes");
  const data = await req.json();

  const tbody = document.getElementById("tabela-estoque");
  tbody.innerHTML = "";

  data.forEach(v => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${v.sku}</td>
      <td>${v.produto_id}</td>
      <td>${v.altura_cm || ""} x ${v.largura_cm || ""}</td>
      <td>${v.cor || ""} / ${v.moldura || ""}</td>
      <td>R$ ${v.preco_base}</td>
      <td id="qtd-${v.variante_id}">${v.estoque}</td>
      
      <td>
        <input id="in-${v.variante_id}" class="estoque-input" type="number">
        <button onclick="entrada(${v.variante_id})">OK</button>
      </td>
      
      <td>
        <input id="out-${v.variante_id}" class="estoque-input" type="number">
        <button onclick="saida(${v.variante_id})">OK</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function entrada(variante_id) {
  const qtd = parseInt(document.getElementById(`in-${variante_id}`).value);
  if (!qtd || qtd <= 0) return alert("Quantidade inválida.");

  const req = await fetch("/estoque/entrada_sku", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      variante_id,
      quantidade: qtd,
      usuario_id: 1,
      motivo: "Entrada manual"
    })
  });

  const res = await req.json();
  if (res.status === "ok") {
    document.getElementById(`qtd-${variante_id}`).textContent = res.estoque_atual;
    document.getElementById(`in-${variante_id}`).value = "";
  } else alert(res.mensagem);
}

async function saída(variante_id) {
  const qtd = parseInt(document.getElementById(`out-${variante_id}`).value);
  if (!qtd || qtd <= 0) return alert("Quantidade inválida.");

  const req = await fetch("/estoque/saida_sku", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      variante_id,
      quantidade: qtd,
      usuario_id: 1,
      motivo: "Saída manual"
    })
  });

  const res = await req.json();
  if (res.status === "ok") {
    document.getElementById(`qtd-${variante_id}`).textContent = res.estoque_atual;
    document.getElementById(`out-${variante_id}`).value = "";
  } else alert(res.mensagem);
}

carregarEstoque();
</script>
</body>
</html>
