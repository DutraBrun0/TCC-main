<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Mev Glass OS</title>
<link rel="stylesheet" href="{{ url_for('static', filename='inicio.css') }}">
</head>
<body>
<header>
    <h1>prodmanager</h1>
</header>

<main>
    <section>
        <h2 id="welcome-message">Bem-vindo(a) de volta!</h2>
        <div class="action-hub">
            <a href="{{ url_for('faturamento_page') }}" class="action-card">
                <span>Nova Venda</span>
            </a>
            <a href="{{ url_for('produtos_page') }}" class="action-card">
                <span>Adicionar Produto</span>
            </a>
            <a href="{{ url_for('estoque_page') }}" class="action-card">
                <span>Ver Estoque</span>
            </a>
            <a href="{{ url_for('clientes_page') }}" class="action-card">
                <span>Novo Cliente</span>
            </a>
        </div>
    </section>

    <div class="dashboard-columns">
        <section>
            <h2>Status do Estoque</h2>
            <div id="stock-status-list">
                <p>Carregando estoque...</p>
            </div>
        </section>

        <section>
            <h2>Atividade Recente</h2>
            <ul class="activity-feed" id="activity-feed">
                <li>Carregando atividades...</li>
            </ul>
        </section>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    // Função utilitária: fetch com fallback de erro
    async function safeFetchJson(url, opts) {
        try {
            const r = await fetch(url, opts);
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return await r.json();
        } catch (err) {
            console.warn("fetch error", url, err);
            return { __error: true, message: err.message || String(err) };
        }
    }

    // 1) Carregar variantes + estoque (usa /estoque/variantes)
    const stockData = await safeFetchJson('/estoque/variantes');
    const stockListContainer = document.getElementById('stock-status-list');
    stockListContainer.innerHTML = '';

    if (stockData && !stockData.__error && Array.isArray(stockData) && stockData.length) {
        // pega 5 variantes com menor estoque
        const sorted = stockData.slice().sort((a,b) => (a.estoque||0) - (b.estoque||0)).slice(0,5);
        sorted.forEach(v => {
            const target = v.minimo || 20; // se não existir, usa 20 como referência
            const percentage = Math.min(((v.estoque || 0) / target) * 100, 100);
            let statusClass = 'high';
            if (percentage < 25) statusClass = 'low';
            else if (percentage < 60) statusClass = 'medium';

            const div = document.createElement('div');
            div.className = 'stock-item';
            div.innerHTML = `
                <div class="stock-item-info">
                    <span>${v.nome_produto}</span>
                    <strong>${v.estoque || 0} Unid.</strong>
                </div>
                <div class="progress-bar" style="border:1px solid #ddd; height:10px; border-radius:6px; background:#f5f5f5;">
                    <div style="height:100%; width:${percentage}%; background:${statusClass === 'low' ? '#e74c3c' : statusClass === 'medium' ? '#f1c40f' : '#2ecc71'}; border-radius:6px"></div>
                </div>
            `;
            stockListContainer.appendChild(div);
        });
    } else {
        stockListContainer.innerHTML = '<p>Não foi possível carregar o estoque via backend. Se o servidor não expõe /estoque/variantes, adicione essa rota.</p>';
    }

    // 2) Atividade recente (tenta /pedido/listar)
    const activityContainer = document.getElementById('activity-feed');
    activityContainer.innerHTML = '';

    const pedidos = await safeFetchJson('/pedido/listar'); // rota pode não existir
    if (pedidos && !pedidos.__error && Array.isArray(pedidos)) {
        const recent = pedidos.slice(-5).reverse();
        if (recent.length === 0) activityContainer.innerHTML = '<li>Nenhuma venda recente.</li>';
        else {
            recent.forEach(p => {
                const li = document.createElement('li');
                li.className = 'feed-item';
                // espera que cada pedido tenha: id, cliente_nome, total, created_at
                li.innerHTML = `<span>Venda #${p.id} — R$ ${parseFloat(p.total||0).toFixed(2)} — ${p.cliente_nome || 'Cliente'}</span>`;
                activityContainer.appendChild(li);
            });
        }
    } else {
        // fallback: informar o administrador
        activityContainer.innerHTML = '<li>Não foi possível carregar vendas (rota /pedido/listar não encontrada).</li>';
    }
});
</script>
</body>
</html>
