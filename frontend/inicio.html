<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Mev Glass OS</title>
<link rel="stylesheet" href="{{ url_for('static', filename='inicio.css') }}">
</head>
<body>
<header>
    <h1>prodmanager</h1>
</header>

<main>
    <section>
        <h2 id="welcome-message">Bem-vindo(a) de volta!</h2>
        <div class="action-hub">
            <a href="{{ url_for('faturamento_page') }}" class="action-card">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414-.336.75-.75.75h-.75m0-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V6.375c0-.621.504-1.125 1.125-1.125h16.5c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m-13.5-9.75h9v6.75h-9z" /></svg>
                <span>Nova Venda</span>
            </a>
            <a href="{{ url_for('produtos_page') }}" class="action-card">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 7.5l-2.25-1.313M21 7.5v2.25m0-2.25l-2.25 1.313M3 7.5l2.25-1.313M3 7.5l2.25 1.313M3 7.5v2.25m9 3l2.25-1.313M12 12.75l-2.25-1.313M12 12.75V15m0 6.75l2.25-1.313M12 21.75l-2.25-1.313M12 21.75v-2.25m9-9l-2.25-1.313M18.75 4.5l-2.25 1.313M18.75 4.5v2.25m-13.5 0l2.25-1.313M5.25 4.5l2.25 1.313M5.25 4.5v2.25m9 3l-2.25-1.313M12 12.75l2.25-1.313M12 12.75V15m0 6.75l-2.25-1.313M12 21.75l2.25-1.313M12 21.75v-2.25" /></svg>
                <span>Adicionar Produto</span>
            </a>
            <a href="{{ url_for('estoque_page') }}" class="action-card">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.436 60.436 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.658-.813A59.905 59.905 0 0112 3.493a59.902 59.902 0 0110.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0l15.482 0m-15.482 0a50.57 50.57 0 01-2.658-.813m2.658.814l-.636 1.908a3.75 3.75 0 01-5.135-2.213m10.27-2.213l.636 1.908a3.75 3.75 0 005.135-2.213m-5.135 0a3.75 3.75 0 01-5.135 2.213L3.75 10.147M20.25 10.147l-.636 1.908a3.75 3.75 0 00-5.135 2.213m5.135-2.213l-.636-1.908" /></svg>
                <span>Ver Estoque</span>
            </a>
            <a href="{{ url_for('clientes_page') }}" class="action-card">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.228a4.5 4.5 0 00-1.025-.972l-2.572-1.04A3.375 3.375 0 003 11.02V14.25a3.375 3.375 0 002.342 3.284l1.046.348m0 0a4.5 4.5 0 001.025.972m-1.046-.348a4.5 4.5 0 01-1.025-.972m1.046.348L6.75 18.25m-.5-1.421a4.5 4.5 0 011.025.972m-1.025-.972L3.75 15.25m4.5-4.5V6a3.375 3.375 0 00-3.375-3.375S3.75 3 3.75 6v1.928M15 10.5a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zm0 0c0 1.683-.753 3.224-1.97 4.228M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" /></svg>
                <span>Novo Cliente</span>
            </a>
        </div>
    </section>

    <div class="dashboard-columns">
        <section>
            <h2>Status do Estoque</h2>
            <div id="stock-status-list">
                </div>
        </section>
        
        <section>
            <h2>Atividade Recente</h2>
            <ul class="activity-feed" id="activity-feed">
                </ul>
        </section>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const produtos = JSON.parse(localStorage.getItem('produtos') || '[]');
        const clientes = JSON.parse(localStorage.getItem('clientes') || '[]');
        const faturamentos = JSON.parse(localStorage.getItem('faturamentos') || '[]');

        // --- 1. Atualizar Status do Estoque com Barras de Progresso ---
        const stockListContainer = document.getElementById('stock-status-list');
        stockListContainer.innerHTML = '';
        
        // Ordena produtos por estoque (menor primeiro) e pega os 5 piores
        const sortedProducts = [...produtos].sort((a, b) => a.estoque - b.estoque).slice(0, 5);

        if (sortedProducts.length > 0) {
            sortedProducts.forEach(p => {
                const percentage = Math.min((p.estoque / 20) * 100, 100); // Ex: 20 é um estoque "saudável"
                let statusClass = 'high';
                if (percentage < 25) statusClass = 'low';
                else if (percentage < 60) statusClass = 'medium';

                const stockItemHTML = `
                    <div class="stock-item">
                        <div class="stock-item-info">
                            <span>${p.nome}</span>
                            <strong>${p.estoque} Unid.</strong>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill ${statusClass}" style="width: ${percentage}%;"></div>
                        </div>
                    </div>
                `;
                stockListContainer.innerHTML += stockItemHTML;
            });
        } else {
            stockListContainer.innerHTML = '<p>Nenhum produto cadastrado para monitorar o estoque.</p>';
        }

        // --- 2. Montar Feed de Atividades Recentes ---
        const activityFeedContainer = document.getElementById('activity-feed');
        activityFeedContainer.innerHTML = '';

        // Combina e ordena as atividades (simulando ordem de inserção)
        const recentFaturamentos = faturamentos.slice(-3).map(f => ({...f, type: 'faturamento'}));
        const recentClientes = clientes.slice(-2).map(c => ({...c, type: 'cliente'}));
        
        // Intercala as atividades para um feed mais dinâmico
        const feedItems = [];
        if (recentFaturamentos[2]) feedItems.push(recentFaturamentos[2]);
        if (recentClientes[1]) feedItems.push(recentClientes[1]);
        if (recentFaturamentos[1]) feedItems.push(recentFaturamentos[1]);
        if (recentClientes[0]) feedItems.push(recentClientes[0]);
        if (recentFaturamentos[0]) feedItems.push(recentFaturamentos[0]);

        if (feedItems.length > 0) {
            feedItems.forEach(item => {
                let itemHTML = '';
                if (item.type === 'faturamento') {
                    const clienteNome = clientes[item.cliente]?.nome || 'Cliente Desconhecido';
                    itemHTML = `
                        <li class="feed-item">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="#27ae60"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414-.336.75-.75.75h-.75m0-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V6.375c0-.621.504-1.125 1.125-1.125h16.5c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m-13.5-9.75h9v6.75h-9z" /></svg>
                            <span>Venda de <strong>R$ ${item.total.toFixed(2)}</strong> para <strong>${clienteNome}</strong>.</span>
                        </li>
                    `;
                } else if (item.type === 'cliente') {
                    itemHTML = `
                        <li class="feed-item">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="#3498db"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.5 21c-2.39 0-4.64-.666-6.5-1.765z" /></svg>
                            <span>Novo cliente cadastrado: <strong>${item.nome}</strong>.</span>
                        </li>
                    `;
                }
                activityFeedContainer.innerHTML += itemHTML;
            });
        } else {
            activityFeedContainer.innerHTML = '<li>Nenhuma atividade recente registrada.</li>';
        }
    });
</script>
</body>
</html>